{% extends 'base.html' %}
{% load static %}

{% block title %}Mood Tracking - MindBridge{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Mood Tracking</h1>
                        <p class="mt-1 text-sm text-gray-500">Track your daily moods and emotions with our intuitive interface</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="bg-blue-50 px-4 py-2 rounded-lg">
                            <span class="text-sm text-blue-600 font-medium">Weekly Average: {{ week_average }}/5</span>
                        </div>
                        <button onclick="openMoodModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-150">
                            ✓ Daily Check-in
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Mood Analytics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            📊
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Daily Check-ins</p>
                        <p class="text-2xl font-semibold text-gray-900">{{ mood_history|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                            📈
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Week Average</p>
                        <p class="text-2xl font-semibold text-gray-900">{{ week_average }}/5</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            🎯
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Personalized Insights</p>
                        <p class="text-2xl font-semibold text-gray-900">3</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                            ⚡
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Streak</p>
                        <p class="text-2xl font-semibold text-gray-900">7 days</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Mood History -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">Mood Analytics & Trends</h2>
                    </div>
                    <div class="p-6">
                        <!-- Mood Chart -->
                        <div class="mb-6">
                            <canvas id="moodChart" width="400" height="200"></canvas>
                        </div>
                        
                        <!-- Recent Entries -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Entries</h3>
                            <div class="space-y-4">
                                {% for entry in mood_history %}
                                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition duration-150">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-4 mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-medium text-gray-900">{{ entry.date }}</span>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                        {% if entry.mood_rating >= 4 %}bg-green-100 text-green-800
                                                        {% elif entry.mood_rating == 3 %}bg-yellow-100 text-yellow-800
                                                        {% else %}bg-red-100 text-red-800{% endif %}">
                                                        {{ entry.get_mood_rating_display }}
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    Overall Score: {{ entry.mood_score }}/5
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-4 mb-3 text-sm">
                                                <div>
                                                    <span class="text-gray-500">Energy:</span>
                                                    <span class="font-medium">{{ entry.energy_level }}/5</span>
                                                </div>
                                                <div>
                                                    <span class="text-gray-500">Stress:</span>
                                                    <span class="font-medium">{{ entry.stress_level }}/5</span>
                                                </div>
                                                {% if entry.sleep_hours %}
                                                <div>
                                                    <span class="text-gray-500">Sleep:</span>
                                                    <span class="font-medium">{{ entry.sleep_hours }}h</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if entry.emotions %}
                                            <div class="mb-3">
                                                <span class="text-sm text-gray-500">Emotions:</span>
                                                <div class="flex flex-wrap gap-1 mt-1">
                                                    {% for emotion in entry.emotions %}
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800">
                                                        {{ emotion|title }}
                                                    </span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if entry.notes %}
                                            <p class="text-sm text-gray-700 bg-gray-50 p-2 rounded">{{ entry.notes }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-center py-8">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        📊
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900 mb-2">No mood entries yet</h3>
                                    <p class="text-gray-500 mb-4">Start tracking your mood to see insights and trends</p>
                                    <button onclick="openMoodModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                        Add Your First Entry
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Mood Check -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Mood Check</h3>
                    <p class="text-sm text-gray-600 mb-4">How are you feeling right now?</p>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        {% for i in "12345" %}
                        <button class="mood-quick-btn w-full h-12 rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition duration-150 text-2xl"
                                data-mood="{{ i }}">
                            {% if i == "1" %}😢
                            {% elif i == "2" %}😕
                            {% elif i == "3" %}😐
                            {% elif i == "4" %}😊
                            {% else %}😄{% endif %}
                        </button>
                        {% endfor %}
                    </div>
                    
                    <button onclick="openMoodModal()" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition duration-150">
                        Detailed Check-in
                    </button>
                </div>

                <!-- Mood Insights -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Personalized Insights</h3>
                    <div class="space-y-3">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-green-800">Positive Trend</h4>
                            <p class="text-sm text-green-700 mt-1">Your mood has improved by 0.8 points this week!</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-blue-800">Sleep Pattern</h4>
                            <p class="text-sm text-blue-700 mt-1">Better sleep seems to correlate with higher mood scores.</p>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <h4 class="text-sm font-medium text-purple-800">Recommendation</h4>
                            <p class="text-sm text-purple-700 mt-1">Try morning meditation - it helped improve your mood last week.</p>
                        </div>
                    </div>
                </div>

                <!-- Mood Resources -->
                <div class="bg-white shadow rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Helpful Resources</h3>
                    <div class="space-y-3">
                        <a href="{% url 'wellness-resources' %}" class="block text-indigo-600 hover:text-indigo-700 text-sm">
                            🧘‍♀️ Guided Meditations
                        </a>
                        <a href="{% url 'crisis-support' %}" class="block text-red-600 hover:text-red-700 text-sm">
                            🆘 Crisis Support
                        </a>
                        <a href="{% url 'wellness-goals' %}" class="block text-green-600 hover:text-green-700 text-sm">
                            🎯 Set Wellness Goals
                        </a>
                        <a href="{% url 'appointment-list' %}" class="block text-blue-600 hover:text-blue-700 text-sm">
                            👨‍⚕️ Professional Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mood Entry Modal -->
    <div id="moodModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">Daily Mood Check-in</h3>
                        <button onclick="closeMoodModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="X6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <form method="post" class="p-6 space-y-6">
                    {% csrf_token %}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Overall Mood</label>
                        <div class="grid grid-cols-5 gap-3">
                            {% for i in "12345" %}
                            <label class="cursor-pointer">
                                <input type="radio" name="mood_rating" value="{{ i }}" class="sr-only" required>
                                <div class="mood-option w-full h-16 rounded-lg border-2 border-gray-200 hover:border-indigo-500 transition duration-150 flex flex-col items-center justify-center text-2xl">
                                    {% if i == "1" %}😢<div class="text-xs mt-1">Very Poor</div>
                                    {% elif i == "2" %}😕<div class="text-xs mt-1">Poor</div>
                                    {% elif i == "3" %}😐<div class="text-xs mt-1">Fair</div>
                                    {% elif i == "4" %}😊<div class="text-xs mt-1">Good</div>
                                    {% else %}😄<div class="text-xs mt-1">Excellent</div>{% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Emotions (select all that apply)</label>
                        <div class="grid grid-cols-3 gap-2">
                            {% for value, label in emotion_choices %}
                            <label class="flex items-center">
                                <input type="checkbox" name="emotions" value="{{ value }}" class="rounded border-gray-300 text-indigo-600">
                                <span class="ml-2 text-sm text-gray-700">{{ label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Energy Level</label>
                            <select name="energy_level" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="1">Very Low</option>
                                <option value="2">Low</option>
                                <option value="3" selected>Moderate</option>
                                <option value="4">High</option>
                                <option value="5">Very High</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stress Level</label>
                            <select name="stress_level" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="1">Very Low</option>
                                <option value="2">Low</option>
                                <option value="3" selected>Moderate</option>
                                <option value="4">High</option>
                                <option value="5">Very High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sleep Hours (last night)</label>
                        <input type="number" name="sleep_hours" step="0.5" min="0" max="24" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2"
                               placeholder="8.5">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">What triggered these feelings?</label>
                        <textarea name="triggers" rows="2" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2"
                                  placeholder="Work stress, relationship issues, etc."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Coping strategies that helped</label>
                        <textarea name="coping_strategies" rows="2" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2"
                                  placeholder="Meditation, exercise, talking to friends, etc."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional notes</label>
                        <textarea name="notes" rows="3" 
                                  class="w-full border border-gray-300 rounded-md px-3 py-2"
                                  placeholder="How are you feeling today? What's on your mind?"></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition duration-150">
                            Save Entry
                        </button>
                        <button type="button" onclick="closeMoodModal()" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition duration-150">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function openMoodModal() {
    document.getElementById('moodModal').classList.remove('hidden');
}

function closeMoodModal() {
    document.getElementById('moodModal').classList.add('hidden');
}

// Mood selection handling
document.querySelectorAll('.mood-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
    });
});

// Create mood chart
const ctx = document.getElementById('moodChart').getContext('2d');
const moodChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for entry in mood_history reversed %}'{{ entry.date|date:"M d" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Mood',
            data: [{% for entry in mood_history reversed %}{{ entry.mood_rating }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            tension: 0.1
        }, {
            label: 'Energy',
            data: [{% for entry in mood_history reversed %}{{ entry.energy_level }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.1
        }, {
            label: 'Stress',
            data: [{% for entry in mood_history reversed %}{{ entry.stress_level }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 5
            }
        }
    }
});
</script>

<style>
.mood-option.selected {
    border-color: #6366f1;
    background-color: #eef2ff;
}
</style>
{% endblock %}
